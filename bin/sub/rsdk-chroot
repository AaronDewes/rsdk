#!/usr/bin/env bash

SCRIPT_NAME="$(basename "$0")"
SCRIPT_DIR="$(dirname "$(realpath "$0")")"
# shellcheck source=bin/lib/utils.sh
source "$SCRIPT_DIR/../lib/utils.sh"

if [[ -f "/.dockerenv" ]]; then
	error "$EXIT_RUNNING_IN_CONTAINER"
fi

if [[ $SCRIPT_NAME == "rsdk-chroot" ]] && (($# < 1)); then
	error "$EXIT_TOO_FEW_ARGUMENTS"
elif [[ $SCRIPT_NAME == "rsdk-install" ]] && (($# < 2)); then
	error "$EXIT_TOO_FEW_ARGUMENTS"
fi

disk="$1"
shift

if [[ -f $disk ]]; then
	disk_file="$disk"
	trap 'set +e; sudo -n true && (sudo umount -R /mnt; sudo kpartx -d "$disk_file"; sync)' SIGINT SIGQUIT SIGTSTP EXIT
	sudo kpartx -a "$disk"
	echo "Target is a file. Trying to find rootfs partition..."
	if ! disk="$(sudo blkid -t LABEL=rootfs -o device | grep /dev/mapper/loop | tail -n 1)"; then
		error "$EXIT_BLKDEV_NO_ROOTDEV" "$disk"
	fi
	disk="${disk%p*}p"
fi

if [[ ! -b $disk ]] && [[ $disk != /dev/mapper/loop* ]]; then
	error "$EXIT_NOT_BLOCK_DEVICE" "$disk"
fi

sudo umount -R /mnt || true

if [[ -b "$disk"3 ]]; then
	# latest rbuild/rsdk image
	sudo mount "$disk"3 /mnt
	sudo mount "$disk"2 /mnt/boot/efi
	sudo mount "$disk"1 /mnt/config
elif [[ -b "$disk"2 ]]; then
	sudo mount "$disk"2 /mnt
	case "$(sudo blkid "$disk"1 -s LABEL -o value)" in
	"armbi_boot")
		# new armbian image
		sudo mount "$disk"1 /mnt/boot
		;;
	*)
		# old rbuild image
		sudo mount "$disk"1 /mnt/config
		;;
	esac
elif [[ -b "$disk"1 ]]; then
	# old armbian image
	sudo mount "$disk"1 /mnt
else
	error "$EXIT_BLKDEV_NO_ROOTDEV" "$disk"
fi

case "$SCRIPT_NAME" in
rsdk-chroot)
	sudo systemd-nspawn -D /mnt "$@"
	;;
rsdk-install)
	file="${1:-}"
	ext="${file##*.}"
	case "$ext" in
	deb)
		sudo cp "$file" /mnt
		sudo systemd-nspawn -D /mnt bash -c \
			"dpkg -i '/$(basename "$file")' && \
                apt-get install -y --fix-missing  --allow-downgrades"
		;;
	dtbo)
		sudo cp "$file" /mnt/boot/dtbo
		sudo systemd-nspawn -D /mnt u-boot-update
		;;
	dtb)
		sudo find /mnt/usr/lib/linux-image-*/ -name "$(basename "$file")" -exec mv "{}" "{}.bak" \; -exec cp "$file" "{}" \;
		;;
	*)
		error "$EXIT_UNSUPPORTED_OPTION" "$file"
		;;
	esac
	;;
esac

sudo umount -R /mnt

sync
