#!/usr/bin/env bash

SCRIPT_DIR="$(dirname "$(realpath "$0")")"
# shellcheck source=bin/lib/utils.sh
source "$SCRIPT_DIR/../lib/utils.sh"

PRODUCT="${1}"
SUITE="${2:-bullseye}"
EDITION="${3:-cli}"
OUTPUT="$PWD/out/${PRODUCT}_${SUITE}_${EDITION}"
mkdir -p "$OUTPUT"

RSDK_OPTION_DEBUG="${RSDK_OPTION_DEBUG:-false}"
RSDK_OPTION_REPO_SUFFIX="${RSDK_OPTION_REPO_SUFFIX:-}"
RSDK_OPTION_DISTRO_MIRROR="${RSDK_OPTION_DISTRO_MIRROR:-}"
RSDK_OPTION_RADXA_MIRROR="${RSDK_OPTION_RADXA_MIRROR:-}"
RSDK_OPTION_ROOTFS="${RSDK_OPTION_ROOTFS:-rootfs.tar}"

TEMP="$(mktemp -d)"
# Need the temp folder to be viewable for apt-key to access
chmod 0755 "$TEMP"
if [[ $RSDK_OPTION_DEBUG == "true" ]]; then
	echo "rsdk temp dir: $TEMP"
fi

JSONNET_ARGS=(
	"--tla-str" "product=$PRODUCT"
	"--tla-str" "suite=$SUITE"
	"--tla-str" "edition=$EDITION"
	"--tla-str" "temp_dir=$TEMP"
	"--tla-str" "output_dir=$OUTPUT"
	"--tla-str" "build_date=$(date --iso-8601=s)"
)
BDEBSTRAP_ARGS=()

if [[ $RSDK_OPTION_DEBUG == "true" ]]; then
	BDEBSTRAP_ARGS+=("--debug")
fi

if [[ -n ${RSDK_OPTION_ROOTFS} ]]; then
	JSONNET_ARGS+=("--tla-str" "rootfs=rootfs")
fi

if [[ -n ${RSDK_OPTION_DISTRO_MIRROR} ]]; then
	JSONNET_ARGS+=("--tla-str" "distro_mirror=$RSDK_OPTION_DISTRO_MIRROR")
fi

if [[ -n ${RSDK_OPTION_RADXA_MIRROR} ]]; then
	JSONNET_ARGS+=("--tla-str" "radxa_mirror=$RSDK_OPTION_RADXA_MIRROR")
fi

if [[ -n ${RSDK_OPTION_REPO_SUFFIX} ]]; then
	JSONNET_ARGS+=("--tla-str" "radxa_repo_suffix=$RSDK_OPTION_REPO_SUFFIX")
fi

# Prepare keyrings
rsdk prepare-keyrings "$TEMP/keyrings/"

jsonnet "${JSONNET_ARGS[@]}" "$SCRIPT_DIR/../../templates/rootfs.jsonnet" -o "$TEMP/rootfs.json"
if [[ $RSDK_OPTION_DEBUG == "true" ]]; then
	cat "$TEMP/rootfs.json"
fi
sudo "$(command -v bdebstrap)" "${BDEBSTRAP_ARGS[@]}" -c "$TEMP/rootfs.json" --name "$OUTPUT" --force
sudo chown -R "$UID:${GID:-$UID}" "$OUTPUT"
rm -rf "$TEMP"
